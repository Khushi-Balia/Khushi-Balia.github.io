<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Implementing the Cpu0 Backend | Khushi  Balia</title>
    <meta name="author" content="Khushi  Balia" />
    <meta name="description" content="Week 2" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Bootstrap Table -->
    <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light" />

    
    <!-- Sidebar Table of Contents -->
    <link href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css" rel="stylesheet" />
    

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://khushi-balia.github.io/blog/2023/week-2/">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark" />

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Khushi&nbsp;</span>Balia</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">About</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">GSoC<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/publications/"></a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/projects/"></a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/"></a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/"></a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/teaching/"></a>
              </li>
              <li class="nav-item dropdown ">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/publications/"></a>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item" href="/projects/"></a>
                </div>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      
        
        <div class="row">
          <!-- sidebar, which will move to the top on a small screen -->
          <div class="col-sm-3">
            <nav id="toc-sidebar" class="sticky-top"></nav>
          </div>
          <!-- main content area -->
          <div class="col-sm-9">
            <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Implementing the Cpu0 Backend</h1>
    <p class="post-meta">June 14, 2023</p>
    <p class="post-tags">
      <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>

    </p>
  </header>

  <article class="post-content">
    
    <div id="markdown-content">
      <p>LLVM is a widely used open-source compiler infrastructure that provides a set of modular and reusable compiler and toolchain technologies. One of the key strengths of LLVM is its extensibility, allowing developers to add support for new architectures by building backend targets. In this blog, we will walk you through the process of building the Cpu0 backend in LLVM, enabling you to generate code for the Cpu0 architecture. Let’s get started!</p>

<h5 id="the-cpu0-backend">The Cpu0 Backend</h5>

<p>Cpu0 is a 32-bit architecture. This is the reference of the Cpu0 backend in LLVM
<a href="https://jonathan2251.github.io/lbd/llvmstructure.html">Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</a></p>

<blockquote class="block-warning">
  <h5 id="warning">WARNING</h5>

  <p>This tutorial was based on LLVM version 3.1. It does not have support for the recent versions of LLVM.</p>
</blockquote>

<p>For this reason, I decided to use the LLVM version 8.0 after making a few changes in the codebase.
This <a href="https://github.com/P2Tree/LLVM_for_cpu0">repository</a> has the code which supports the LLVM version 8.0</p>

<h5 id="building-the-backend">Building the backend</h5>

<ol>
  <li>
    <p>Build the <a href="https://github.com/llvm/llvm-project">LLVM version 8.0</a></p>
  </li>
  <li>
    <p>Clone <a href="https://github.com/P2Tree/LLVM_for_cpu0">this</a> repository.</p>
  </li>
  <li>
    <p>Run the following commands:</p>

    <div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">cmake</span> <span class="nt">-G</span> <span class="s2">"Unix Makefiles"</span> <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span><span class="nt">Debug</span> <span class="nc">..</span><span class="o">/</span><span class="nt">llvm</span>
<span class="nt">ninja</span>
</code></pre></div>    </div>
    <p>or just to build the Cpu0 target, run</p>

    <div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">cmake</span> <span class="nt">-G</span> <span class="s2">"Unix Makefiles"</span> <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span><span class="nt">Debug</span> <span class="nt">-DLLVM_TARGETS_TO_BUILD</span><span class="o">=</span><span class="nt">Cpu0</span> <span class="nc">..</span><span class="o">/</span><span class="nt">llvm</span>
<span class="nt">ninja</span>
</code></pre></div>    </div>
  </li>
  <li>Then run
    <div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">cmake</span> <span class="nt">-DCMAKE_CXX_COMPILER</span><span class="o">=</span><span class="nt">clang</span><span class="o">++</span> <span class="nt">-DCMAKE_C_COMPILER</span><span class="o">=</span><span class="nt">clang</span> <span class="nt">-DCMAKE_BUILD_TYPE</span><span class="o">=</span><span class="nt">Debug</span> <span class="nt">-G</span> <span class="s2">"Ninja"</span> <span class="nc">..</span><span class="o">/</span><span class="nt">llvm</span>
<span class="nt">ninja</span>
</code></pre></div>    </div>
  </li>
  <li>Followed by
    <div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">build</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">llc</span> <span class="nt">--version</span>
</code></pre></div>    </div>

    <blockquote class="block-tip">
      <h5 id="tip">TIP</h5>

      <p>Remember to invoke the llc that we just built, not the system llc.
You can check which llc is being used by running <code class="language-plaintext highlighter-rouge">which llc</code>.
Source the built compiler path</p>
    </blockquote>
  </li>
  <li>Run these commands
    <div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">export</span><span class="err"> </span><span class="na">PATH</span><span class="err">=&lt;</span><span class="na">path</span><span class="err">&gt;</span><span class="p">:</span><span class="nv">$PATH</span> 
  <span class="n">export</span> <span class="n">LIBRARY_PATH</span><span class="o">=&lt;</span><span class="n">path</span><span class="o">&gt;:</span><span class="nv">$LIBRARY_PATH</span>
  <span class="n">export</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=&lt;</span><span class="n">path</span><span class="o">&gt;:</span><span class="nv">$LD_LIBRARY_PATH</span>
</code></pre></div>    </div>
  </li>
  <li>Try running some test cases/examples
    <div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">build</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">clang</span> <span class="nt">-target</span> <span class="nt">x86_64-unknown-linux-gnu</span> <span class="nt">-c</span> <span class="nt">example</span><span class="nc">.c</span> <span class="nt">-S</span> <span class="nt">-emit-llvm</span> <span class="nt">-o</span> <span class="nt">example</span><span class="nc">.ll</span>
<span class="nt">build</span><span class="o">/</span><span class="nt">bin</span><span class="o">/</span><span class="nt">llc</span> <span class="nt">-march</span><span class="o">=</span><span class="nt">cpu0</span> <span class="nt">-mcpu</span><span class="o">=</span><span class="nt">cpu032I</span> <span class="nt">-relocation-model</span><span class="o">=</span><span class="nt">pic</span> <span class="nt">-filetype</span><span class="o">=</span><span class="nt">asm</span> <span class="nt">example</span><span class="nc">.ll</span> <span class="nt">-o</span> <span class="nt">-</span>
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="my-week-2-progress">My Week 2 progress</h5>

<p>During the second week while building the Cpu0 backend in LLVM, I encountered some challenges related to the compatibility of LLVM versions. Here’s a breakdown of my progress and the solutions I found:</p>

<ul>
  <li>
    <p>Attempt: LLVM Version 12
In the beginning, I attempted to build the Cpu0 backend using LLVM version 12. However, I discovered that the Cpu0 backend was not supported in this version. Despite my efforts to modify the LLVM source code, it became clear that the necessary components for the Cpu0 backend were not present.</p>

    <p>Solution 1:
Realizing that version 12 did not support the Cpu0 backend, I decided to explore earlier versions of LLVM to find the desired compatibility.</p>
  </li>
  <li>
    <p>Attempt 2: LLVM Version 10
Next, I tried building the Cpu0 backend using LLVM version 10. Unfortunately, I encountered the same issue as with version 12.</p>

    <p>Solution 2:
Undeterred, I turned to the open-source community to find a solution. After some research, I came across a <a href="https://github.com/P2Tree/LLVM_for_cpu0">repository</a> that contained an unofficial version of the Cpu0 backend for LLVM 8.</p>
  </li>
  <li>
    <p>Attempt 3: LLVM Version 8
Using the GitHub repository as a reference, I started building the Cpu0 backend in LLVM version 8. This involved downloading the LLVM 8 source code and incorporating the necessary files from the repository.</p>

    <p>Solution 3:
By following the instructions provided in the GitHub repository, I successfully built the Cpu0 backend in LLVM version 8 and ran some examples.</p>
  </li>
</ul>

    </div>
  </article>


  
    
    <br>
    <hr>
    <br>
    <ul class="list-disc pl-8"></ul>

    <!-- Adds related posts to the end of an article -->
    <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2>
    <p class="mb-2">Here are some more articles you might like to read next:</p>
  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/week-1/">Flashing the Beaglebone black and learning about the pru assembly</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/mom-target/">Weekly meets and targets</a>
  </li>

</div>

          </div>
        </div>
        
      
    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        &copy; Copyright 2023 Khushi  Balia. 
      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script>
  <!-- Sidebar Table of Contents -->
  <script defer src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script>


  <!-- Bootstrap Table -->
  <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script>

  <!-- Load Common JS -->
  <script src="/assets/js/no_defer.js"></script>
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
